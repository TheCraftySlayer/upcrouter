<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Property Driving Directions</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%); min-height: 100vh; padding: 16px; }
    .container { max-width: 600px; margin: 0 auto; }
    h1 { font-size: 1.75rem; color: #1e293b; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
    h1 .icon { font-size: 2rem; }
    .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1); padding: 20px; margin-bottom: 16px; border: 1px solid #e2e8f0; }
    .card h2 { font-size: 1.1rem; color: #334155; margin-bottom: 8px; }
    .card h3 { font-size: 1rem; color: #334155; margin-bottom: 12px; }
    .card p { color: #64748b; font-size: 0.875rem; margin-bottom: 16px; }
    code { background: #f1f5f9; padding: 2px 8px; border-radius: 4px; color: #2563eb; font-size: 0.875rem; }
    input[type="file"] { display: block; width: 100%; font-size: 0.875rem; cursor: pointer; }
    input[type="file"]::file-selector-button { margin-right: 16px; padding: 10px 20px; border-radius: 8px; border: none; font-weight: 600; background: #2563eb; color: white; cursor: pointer; transition: background 0.2s; }
    input[type="file"]::file-selector-button:hover { background: #1d4ed8; }
    .success-banner { background: #ecfdf5; border: 1px solid #6ee7b7; border-radius: 12px; padding: 12px 16px; margin-bottom: 16px; display: flex; align-items: center; justify-content: space-between; min-height: 48px; }
    .success-banner .success-text { color: #047857; font-weight: 500; font-size: 0.95rem; }
    .success-banner button { background: none; border: none; color: #059669; font-size: 0.875rem; cursor: pointer; font-weight: 500; padding: 4px 8px; white-space: nowrap; }
    .success-banner button:hover { text-decoration: underline; }
    textarea { width: 100%; height: 150px; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 0.875rem; font-family: 'Monaco', 'Consolas', monospace; resize: none; }
    textarea:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59,130,246,0.2); }
    textarea:disabled { background: #f1f5f9; }
    .hint { font-size: 0.75rem; color: #94a3b8; margin: 4px 0 12px; }
    .btn-row { display: flex; gap: 8px; }
    .btn { padding: 12px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; border: none; font-size: 0.95rem; }
    .btn-primary { flex: 1; background: #2563eb; color: white; }
    .btn-primary:hover { background: #1d4ed8; }
    .btn-primary:disabled { background: #94a3b8; cursor: not-allowed; }
    .btn-secondary { background: white; border: 1px solid #cbd5e1; color: #334155; }
    .btn-secondary:hover { background: #f8fafc; }
    .error { margin-top: 12px; padding: 8px 12px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; color: #dc2626; font-size: 0.875rem; }
    .route-list { max-height: 300px; overflow-y: auto; margin-bottom: 16px; }
    .route-item { display: flex; align-items: center; gap: 8px; padding: 8px; background: #f8fafc; border-radius: 8px; margin-bottom: 8px; border: 1px solid #f1f5f9; transition: all 0.2s ease; }
    .route-item.start, .route-item.end { background: #ecfdf5; border-color: #6ee7b7; }
    .route-item.draggable { cursor: grab; }
    .route-item.draggable:hover { background: #eff6ff; border-color: #93c5fd; }
    .route-item.draggable:active { cursor: grabbing; }
    .route-item.dragging { opacity: 0.5; background: #dbeafe; border: 2px dashed #3b82f6; }
    .route-item.drag-over { border: 2px solid #3b82f6; background: #eff6ff; transform: scale(1.02); }
    .route-num { width: 24px; height: 24px; background: #2563eb; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 700; flex-shrink: 0; }
    .route-num.start, .route-num.end { background: #16a34a; }
    .route-label { font-size: 0.75rem; color: #475569; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; }
    .route-label.mono { font-family: monospace; }
    .short-code { font-size: 0.7rem; color: #2563eb; background: #eff6ff; padding: 2px 6px; border-radius: 4px; font-weight: 600; white-space: nowrap; }
    .drag-handle { color: #94a3b8; font-size: 1rem; padding: 0 4px; flex-shrink: 0; }
    .route-buttons { display: flex; flex-direction: column; gap: 8px; }
    .btn-google { background: #16a34a; color: white; width: 100%; padding: 14px; font-size: 1rem; }
    .btn-google:hover { background: #15803d; }
    .btn-print { background: #6366f1; color: white; width: 100%; padding: 14px; font-size: 1rem; }
    .btn-print:hover { background: #4f46e5; }
    .route-info { font-size: 0.8rem; color: #64748b; margin-bottom: 12px; padding: 8px; background: #f8fafc; border-radius: 6px; }
    
    /* Print Styles */
    @media print {
      body { background: white; padding: 0; }
      .container { max-width: 100%; }
      .card { box-shadow: none; border: none; page-break-inside: avoid; }
      #upload-section, #success-banner, #input-section, #route-buttons, #map, .map-legend, 
      #route-stats, #updating-indicator, #drag-hint, #route-note, #error-msg,
      .drag-handle, h1, .btn-print, .btn-google, .card > h3, #instructions-card { display: none !important; }
      .route-list { max-height: none; overflow: visible; }
      .route-item { page-break-inside: avoid; padding: 10px 8px; border: 1px solid #ddd; margin-bottom: 4px; }
      .route-item.start, .route-item.end { background: #f0f9f0; }
      .route-item.draggable { cursor: default; background: #fff; }
      .card { padding: 10px; }
      .print-header { display: block !important; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid #333; }
      .print-header h2 { margin: 0 0 4px 0; font-size: 1.25rem; }
      .print-header .print-date { font-size: 0.85rem; color: #666; }
      .print-header .print-count { font-size: 0.9rem; color: #333; margin-top: 4px; }
      .print-checkbox { display: inline-block !important; width: 16px; height: 16px; border: 2px solid #333; margin-right: 8px; flex-shrink: 0; }
      .route-num { font-size: 0.7rem; }
      .short-code { font-size: 0.75rem; }
      .route-label { font-size: 0.8rem; }
      .route-info { display: block; border: 1px solid #999; background: #f5f5f5; }
    }
    
    .print-header { display: none; }
    .print-checkbox { display: none; }
    .print-notes { display: none; }
    
    @media print {
      .print-notes { 
        display: block !important; 
        margin-top: 20px; 
        padding-top: 16px; 
        border-top: 1px solid #ccc; 
      }
      .print-notes-title { 
        font-weight: 600; 
        margin-bottom: 12px; 
        font-size: 0.9rem; 
      }
      .print-notes-lines { 
        height: 100px; 
        background: repeating-linear-gradient(
          transparent,
          transparent 24px,
          #ccc 24px,
          #ccc 25px
        );
      }
    }
    .drag-hint { font-size: 0.75rem; color: #64748b; margin-bottom: 8px; padding: 6px 10px; background: #fef3c7; border: 1px solid #fcd34d; border-radius: 6px; display: flex; align-items: center; gap: 6px; }
    .drag-hint .icon { font-size: 1rem; }
    details summary { list-style: none; }
    details summary::-webkit-details-marker { display: none; }
    details summary::before { content: '‚ñ∂'; margin-right: 8px; font-size: 0.7rem; transition: transform 0.2s; display: inline-block; }
    details[open] summary::before { transform: rotate(90deg); }
    details ul { list-style-type: disc; }
    details li { margin-bottom: 4px; }
    .route-note { font-size: 0.75rem; color: #92400e; margin-bottom: 8px; padding: 6px 10px; background: #fef3c7; border: 1px solid #fcd34d; border-radius: 6px; display: none; }
    .route-note.show { display: block; }
    #map { height: 350px; border-radius: 8px; margin-bottom: 16px; border: 1px solid #e2e8f0; }
    .map-legend { display: flex; gap: 16px; margin-bottom: 12px; flex-wrap: wrap; }
    .legend-item { display: flex; align-items: center; gap: 6px; font-size: 0.75rem; color: #64748b; }
    .legend-dot { width: 12px; height: 12px; border-radius: 50%; }
    .legend-dot.office { background: #16a34a; }
    .legend-dot.property { background: #2563eb; }
    .legend-line { width: 20px; height: 3px; background: #f97316; border-radius: 2px; }
    .custom-marker { background: #2563eb; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
    .custom-marker.office { background: #16a34a; width: 28px; height: 28px; font-size: 14px; }
    .route-stats { display: flex; gap: 16px; margin-bottom: 12px; padding: 10px 12px; background: #eff6ff; border-radius: 8px; border: 1px solid #bfdbfe; }
    .stat { display: flex; flex-direction: column; }
    .stat-value { font-size: 1rem; font-weight: 700; color: #1e40af; }
    .stat-label { font-size: 0.7rem; color: #3b82f6; }
    .loading-route { text-align: center; padding: 12px; color: #64748b; font-size: 0.875rem; }
    .updating-indicator { display: none; align-items: center; gap: 8px; padding: 8px 12px; background: #fef3c7; border: 1px solid #fcd34d; border-radius: 6px; margin-bottom: 12px; font-size: 0.8rem; color: #92400e; }
    .updating-indicator.show { display: flex; }
    .spinner { width: 16px; height: 16px; border: 2px solid #fcd34d; border-top-color: #f59e0b; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="container">
    <h1><span class="icon">üó∫Ô∏è</span> Property Driving Directions</h1>
    
    <div class="card" id="instructions-card">
      <details>
        <summary style="cursor: pointer; font-weight: 600; color: #334155; display: flex; align-items: center; gap: 8px;">
          <span>üìã How to Use This Tool</span>
          <span style="font-size: 0.75rem; color: #64748b; font-weight: 400;">(click to expand)</span>
        </summary>
        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e2e8f0;">
          <div style="margin-bottom: 12px;">
            <strong style="color: #1e40af;">Step 1: Upload Your Data File</strong>
            <p style="margin: 4px 0; color: #475569; font-size: 0.875rem;">Upload an Excel file (.xlsx or .xls) containing property coordinates. The file should have these columns:</p>
            <ul style="margin: 8px 0 8px 20px; color: #475569; font-size: 0.85rem;">
              <li><code>PARID LAT LONG</code> or <code>PARID X Y</code> or <code>PARID</code> ‚Äî The property ID</li>
              <li><code>DRIVING DIRECTIONS LAT LONG</code> ‚Äî Google Maps URL with lat/long in DMS format (preferred)</li>
              <li><code>DRIVING DIRECTIONS</code> ‚Äî Google Maps URL with decimal X/Y coordinates (fallback)</li>
            </ul>
            <p style="margin: 4px 0; color: #64748b; font-size: 0.8rem; font-style: italic;">üí° The tool will try to use Lat/Long coordinates first. If unavailable, it falls back to X/Y coordinates.</p>
          </div>
          <div style="margin-bottom: 12px;">
            <strong style="color: #1e40af;">Step 2: Enter Property IDs (UPCs/PARIDs)</strong>
            <p style="margin: 4px 0; color: #475569; font-size: 0.875rem;">Type or paste one or more property IDs into the text box. You can separate them with commas, spaces, or new lines.</p>
          </div>
          <div style="margin-bottom: 12px;">
            <strong style="color: #1e40af;">Step 3: Build & Customize Your Route</strong>
            <p style="margin: 4px 0; color: #475569; font-size: 0.875rem;">Click "Build Route" to generate your driving itinerary. You can:</p>
            <ul style="margin: 8px 0 8px 20px; color: #475569; font-size: 0.85rem;">
              <li>Drag and drop stops to reorder them</li>
              <li>View the route on the map preview</li>
              <li>Open turn-by-turn directions in Google Maps</li>
              <li>Print a checklist for field work</li>
            </ul>
          </div>
          <div style="background: #fef3c7; padding: 8px 12px; border-radius: 6px; border: 1px solid #fcd34d;">
            <p style="margin: 0; color: #92400e; font-size: 0.8rem;">‚ö†Ô∏è <strong>Note:</strong> Routes with more than 9 stops will be split into multiple segments due to Google Maps limitations.</p>
          </div>
        </div>
      </details>
    </div>
    
    <div id="upload-section" class="card">
      <h2>Load Your Data</h2>
      <p>Upload the <code>driving.xlsx</code> file</p>
      <input type="file" id="file-input" accept=".xlsx,.xls">
    </div>
    
    <div id="success-banner" class="success-banner" style="display: none;">
      <span class="success-text">‚úì <span id="record-count">0</span> properties loaded</span>
      <button type="button" onclick="resetFile()">Change file</button>
    </div>
    
    <div id="input-section" class="card">
      <h3>Enter UPCs (PARIDs)</h3>
      <textarea id="upc-input" placeholder="100806539516140960&#10;100806539516640961&#10;100806539517040962" disabled></textarea>
      <p class="hint">Comma, space, or newline separated</p>
      <div class="btn-row">
        <button id="search-btn" class="btn btn-primary" type="button" onclick="handleSearch()" disabled>üîç Build Route</button>
        <button class="btn btn-secondary" type="button" onclick="clearAll()">Clear</button>
      </div>
      <div id="error-msg" class="error" style="display: none;"></div>
    </div>
    
    <div id="route-section" class="card" style="display: none;">
      <div id="print-header" class="print-header">
        <h2>üó∫Ô∏è Property Driving Itinerary</h2>
        <div class="print-date"></div>
        <div class="print-count"></div>
      </div>
      <h3>üìç Route Preview (<span id="stop-count">0</span> stops)</h3>
      <div class="map-legend">
        <div class="legend-item"><div class="legend-dot office"></div> Office</div>
        <div class="legend-item"><div class="legend-dot property"></div> Property</div>
        <div class="legend-item"><div class="legend-line"></div> Driving Route</div>
      </div>
      <div id="map"></div>
      <div id="route-note" class="route-note">‚ö†Ô∏è Road routing unavailable ‚Äî showing straight lines. Google Maps will still provide turn-by-turn directions.</div>
      <div id="route-stats" class="route-stats" style="display: none;">
        <div class="stat"><span id="total-distance" class="stat-value">--</span><span class="stat-label">Total Distance</span></div>
        <div class="stat"><span id="total-time" class="stat-value">--</span><span class="stat-label">Est. Drive Time</span></div>
      </div>
      <div id="updating-indicator" class="updating-indicator">
        <div class="spinner"></div>
        <span>Fetching road route...</span>
      </div>
      <div id="drag-hint" class="drag-hint" style="display: none;">
        <span class="icon">‚ÜïÔ∏è</span>
        <span>Drag stops to reorder ‚Ä¢ Map & directions update automatically</span>
      </div>
      <div id="route-list" class="route-list"></div>
      <div id="route-info" class="route-info" style="display: none;"></div>
      <div id="print-notes" class="print-notes">
        <div class="print-notes-title">Notes:</div>
        <div class="print-notes-lines"></div>
      </div>
      <div id="route-buttons" class="route-buttons"></div>
    </div>
  </div>

  <script>
    var OFFICE_LAT = 35.08302237882336;
    var OFFICE_LNG = -106.65286131510351;
    var MAX_WAYPOINTS = 9;
    var data = {}, locations = [], fullRoute = [], map = null, mapLayers = [];
    var draggedItem = null;
    var isUpdating = false;

    // Clean UPC - removes ALL whitespace including non-breaking spaces (U+00A0) from Excel
    function cleanUPC(str) {
      return String(str || '').replace(/[\s\u00A0\u2007\u202F]+/g, '').trim();
    }

    var letterMap = {'066':'A','065':'B','064':'C','063':'D','062':'E','061':'F','060':'G','059':'H','058':'J','057':'K','056':'L','055':'M','054':'N','053':'P','052':'Q','051':'R','050':'S','049':'T','048':'U','047':'V','046':'W','045':'X','044':'Y','043':'Z'};
    
    function parseUPC(upc) {
      var s = upc.replace(/\D/g, '');
      if (s.length < 18) return { letter: 'Z', mapNum: 99, quad: 9, block: 99, parcel: 99, shortCode: '???' };
      var letter = letterMap[s.substring(4, 7)] || '?';
      var mapNum = parseInt(s.substring(1, 4), 10) || 0;
      var quad = parseInt(s.substring(13, 14), 10) || 0;
      var block = parseInt(s.substring(14, 16), 10) || 0;
      var parcel = parseInt(s.substring(16, 18), 10) || 0;
      return { letter: letter, mapNum: mapNum, quad: quad, block: block, parcel: parcel, shortCode: letter + mapNum + '-' + quad + (block < 10 ? '0' : '') + block + (parcel < 10 ? '0' : '') + parcel };
    }

    function showEl(id) { document.getElementById(id).style.display = ''; }
    function hideEl(id) { document.getElementById(id).style.display = 'none'; }

    function createMarkerIcon(text, isOffice) {
      return L.divIcon({
        className: 'custom-marker-wrapper',
        html: '<div class="custom-marker' + (isOffice ? ' office' : '') + '">' + text + '</div>',
        iconSize: [isOffice ? 28 : 24, isOffice ? 28 : 24],
        iconAnchor: [isOffice ? 14 : 12, isOffice ? 14 : 12]
      });
    }

    function initMap() {
      if (map) return;
      map = L.map('map').setView([OFFICE_LAT, OFFICE_LNG], 11);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap'
      }).addTo(map);
    }

    async function fetchRouteBetweenTwo(coord1, coord2) {
      var coordString = coord1[1] + ',' + coord1[0] + ';' + coord2[1] + ',' + coord2[0];
      var url = 'https://router.project-osrm.org/route/v1/driving/' + coordString + '?overview=full&geometries=geojson';
      
      for (var attempt = 0; attempt < 2; attempt++) {
        try {
          var response = await fetch(url);
          var data = await response.json();
          if (data.code === 'Ok' && data.routes && data.routes[0]) {
            return {
              geometry: data.routes[0].geometry.coordinates.map(function(c) { return [c[1], c[0]]; }),
              distance: data.routes[0].distance,
              duration: data.routes[0].duration
            };
          }
        } catch (e) {
          if (attempt < 1) {
            await new Promise(function(resolve) { setTimeout(resolve, 500); });
          }
        }
      }
      return null;
    }

    async function fetchDrivingRoute(coords) {
      var allGeometry = [];
      var totalDistance = 0;
      var totalDuration = 0;
      
      // Fetch route between each consecutive pair of points
      for (var i = 0; i < coords.length - 1; i++) {
        var segmentData = await fetchRouteBetweenTwo(coords[i], coords[i + 1]);
        if (!segmentData) {
          return null; // If any segment fails, fall back to straight lines
        }
        
        // Add geometry (skip first point on subsequent segments to avoid duplicates)
        var geomToAdd = (i === 0) ? segmentData.geometry : segmentData.geometry.slice(1);
        allGeometry = allGeometry.concat(geomToAdd);
        totalDistance += segmentData.distance;
        totalDuration += segmentData.duration;
      }
      
      return {
        geometry: allGeometry,
        distance: totalDistance,
        duration: totalDuration
      };
    }

    function formatDistance(meters) {
      var miles = meters / 1609.34;
      return miles.toFixed(1) + ' mi';
    }

    function formatDuration(seconds) {
      var hours = Math.floor(seconds / 3600);
      var mins = Math.round((seconds % 3600) / 60);
      if (hours > 0) return hours + 'h ' + mins + 'm';
      return mins + ' min';
    }

    async function updateMap() {
      if (!map) initMap();
      mapLayers.forEach(function(layer) { map.removeLayer(layer); });
      mapLayers = [];
      if (fullRoute.length === 0) return;

      var bounds = L.latLngBounds();
      var routeCoords = [];

      // Add markers
      for (var i = 0; i < fullRoute.length; i++) {
        var loc = fullRoute[i];
        var latLng = [loc.lat, loc.lng];
        bounds.extend(latLng);
        routeCoords.push(latLng);

        var marker, popupText;
        if (loc.type === 'start') {
          marker = L.marker(latLng, { icon: createMarkerIcon('üè¢', true) });
          popupText = '<b>Start:</b> Assessor Office';
        } else if (loc.type === 'end') {
          marker = L.marker(latLng, { icon: createMarkerIcon('üèÅ', true) });
          popupText = '<b>End:</b> Assessor Office';
        } else {
          var parsed = parseUPC(loc.upc);
          marker = L.marker(latLng, { icon: createMarkerIcon(i, false) });
          popupText = '<b>Stop ' + i + '</b><br>' + parsed.shortCode + '<br><span style="font-size:10px;color:#666;">' + loc.upc + '</span>';
        }
        marker.bindPopup(popupText);
        marker.addTo(map);
        mapLayers.push(marker);
      }

      map.fitBounds(bounds, { padding: [30, 30] });

      // Fetch actual driving route from OSRM
      var routeData = await fetchDrivingRoute(routeCoords);
      
      if (routeData && routeData.geometry) {
        var polyline = L.polyline(routeData.geometry, { 
          color: '#f97316', 
          weight: 4, 
          opacity: 0.85
        }).addTo(map);
        mapLayers.push(polyline);
        
        // Show stats
        document.getElementById('total-distance').textContent = formatDistance(routeData.distance);
        document.getElementById('total-time').textContent = formatDuration(routeData.duration);
        showEl('route-stats');
        document.getElementById('route-note').classList.remove('show');
      } else {
        // Fallback to straight lines if OSRM fails
        var polyline = L.polyline(routeCoords, { 
          color: '#f97316', 
          weight: 3, 
          opacity: 0.8, 
          dashArray: '8, 8' 
        }).addTo(map);
        mapLayers.push(polyline);
        
        // Show estimated stats based on straight-line distance
        var totalMeters = 0;
        for (var j = 0; j < routeCoords.length - 1; j++) {
          totalMeters += map.distance(routeCoords[j], routeCoords[j + 1]);
        }
        // Multiply by 1.4 to estimate actual road distance from straight-line
        var estimatedDistance = totalMeters * 1.4;
        // Estimate 30 mph average speed
        var estimatedSeconds = (estimatedDistance / 1609.34) / 30 * 3600;
        
        document.getElementById('total-distance').textContent = '~' + formatDistance(estimatedDistance);
        document.getElementById('total-time').textContent = '~' + formatDuration(estimatedSeconds);
        showEl('route-stats');
        document.getElementById('route-note').classList.add('show');
      }
    }

    // Drag and Drop Functions
    function handleDragStart(e) {
      draggedItem = this;
      this.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', this.dataset.index);
    }

    function handleDragEnd(e) {
      this.classList.remove('dragging');
      document.querySelectorAll('.route-item').forEach(function(item) {
        item.classList.remove('drag-over');
      });
      draggedItem = null;
    }

    function handleDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
    }

    function handleDragEnter(e) {
      e.preventDefault();
      if (this !== draggedItem && this.classList.contains('draggable')) {
        this.classList.add('drag-over');
      }
    }

    function handleDragLeave(e) {
      this.classList.remove('drag-over');
    }

    async function handleDrop(e) {
      e.preventDefault();
      e.stopPropagation();
      
      this.classList.remove('drag-over');
      
      if (!draggedItem || this === draggedItem || !this.classList.contains('draggable')) {
        return;
      }

      var fromIndex = parseInt(draggedItem.dataset.index);
      var toIndex = parseInt(this.dataset.index);

      if (fromIndex === toIndex) return;

      // Reorder the fullRoute array (property items only, indices 1 to length-2)
      var movedItem = fullRoute.splice(fromIndex, 1)[0];
      fullRoute.splice(toIndex, 0, movedItem);

      // Rebuild locations array from fullRoute (excluding start/end)
      locations = fullRoute.filter(function(loc) {
        return loc.type !== 'start' && loc.type !== 'end';
      });

      // Update UI
      updateRouteList();
      updateRouteButtons();
      
      // Show updating indicator and update map
      showUpdatingIndicator();
      await updateMap();
      hideUpdatingIndicator();
    }

    function showUpdatingIndicator() {
      document.getElementById('updating-indicator').classList.add('show');
      isUpdating = true;
    }

    function hideUpdatingIndicator() {
      document.getElementById('updating-indicator').classList.remove('show');
      isUpdating = false;
    }

    function updateRouteList() {
      var html = '';
      var hasPropertyStops = fullRoute.length > 2; // More than just start/end
      
      for (var i = 0; i < fullRoute.length; i++) {
        var loc = fullRoute[i];
        var itemClass = 'route-item', numClass = 'route-num', labelClass = 'route-label', label, num, shortCodeHtml = '';
        var draggable = false;
        var dragHandle = '';
        var checkbox = '';
        
        if (loc.type === 'start') { 
          itemClass += ' start'; 
          numClass += ' start'; 
          num = 'S'; 
          label = 'üè¢ Office (Start)'; 
        } else if (loc.type === 'end') { 
          itemClass += ' end'; 
          numClass += ' end'; 
          num = 'E'; 
          label = 'üè¢ Office (End)'; 
        } else { 
          num = i; 
          label = loc.upc; 
          labelClass += ' mono'; 
          shortCodeHtml = '<span class="short-code">' + parseUPC(loc.upc).shortCode + '</span>';
          draggable = true;
          itemClass += ' draggable';
          dragHandle = '<span class="drag-handle">‚ò∞</span>';
          checkbox = '<span class="print-checkbox"></span>';
        }
        
        html += '<div class="' + itemClass + '"' + 
                (draggable ? ' draggable="true" data-index="' + i + '"' : '') + 
                '>' + dragHandle + checkbox +
                '<span class="' + numClass + '">' + num + '</span>' +
                '<span class="' + labelClass + '">' + label + '</span>' + 
                shortCodeHtml + '</div>';
      }
      document.getElementById('route-list').innerHTML = html;
      document.getElementById('stop-count').textContent = fullRoute.length;

      // Show drag hint if there are multiple property stops
      if (locations.length > 1) {
        showEl('drag-hint');
      } else {
        hideEl('drag-hint');
      }

      // Add drag event listeners to draggable items
      var draggableItems = document.querySelectorAll('.route-item.draggable');
      draggableItems.forEach(function(item) {
        item.addEventListener('dragstart', handleDragStart);
        item.addEventListener('dragend', handleDragEnd);
        item.addEventListener('dragover', handleDragOver);
        item.addEventListener('dragenter', handleDragEnter);
        item.addEventListener('dragleave', handleDragLeave);
        item.addEventListener('drop', handleDrop);
      });
    }

    function updateRouteButtons() {
      var numRoutes = Math.ceil(locations.length / MAX_WAYPOINTS);
      var buttonsHtml = '', infoEl = document.getElementById('route-info');
      
      // Always add print button first
      buttonsHtml = '<button class="btn btn-print" type="button" onclick="printItinerary()">üñ®Ô∏è Print Itinerary</button>';
      
      if (numRoutes > 1) {
        infoEl.textContent = 'Route split into ' + numRoutes + ' segments (Google Maps limit: ' + MAX_WAYPOINTS + ' stops per route).';
        showEl('route-info');
        for (var r = 0; r < numRoutes; r++) {
          var startIdx = r * MAX_WAYPOINTS, endIdx = Math.min(startIdx + MAX_WAYPOINTS, locations.length);
          var labelParts = [];
          if (r === 0) labelParts.push('Office');
          labelParts.push('Stops ' + (startIdx + 1) + '-' + endIdx);
          if (r === numRoutes - 1) labelParts.push('Office');
          buttonsHtml += '<button class="btn btn-google" type="button" onclick="openGoogleMaps(' + r + ')">üó∫Ô∏è Route ' + (r + 1) + ': ' + labelParts.join(' ‚Üí ') + '</button>';
        }
      } else {
        hideEl('route-info');
        buttonsHtml += '<button class="btn btn-google" type="button" onclick="openGoogleMaps(0)">üó∫Ô∏è Open in Google Maps</button>';
      }
      document.getElementById('route-buttons').innerHTML = buttonsHtml;
    }

    function printItinerary() {
      // Update print header with current info
      var now = new Date();
      var dateStr = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
      var timeStr = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
      
      document.querySelector('#print-header .print-date').textContent = 'Generated: ' + dateStr + ' at ' + timeStr;
      document.querySelector('#print-header .print-count').textContent = locations.length + ' properties to visit';
      
      window.print();
    }

    function openGoogleMaps(routeIndex) {
      var numRoutes = Math.ceil(locations.length / MAX_WAYPOINTS);
      var isFirst = (routeIndex === 0), isLast = (routeIndex === numRoutes - 1);
      var startIdx = routeIndex * MAX_WAYPOINTS, endIdx = Math.min(startIdx + MAX_WAYPOINTS, locations.length);
      var routeLocs = locations.slice(startIdx, endIdx);
      
      var url = 'https://www.google.com/maps/dir/?api=1';
      url += '&origin=' + (isFirst ? OFFICE_LAT + ',' + OFFICE_LNG : routeLocs[0].lat + ',' + routeLocs[0].lng);
      url += '&destination=' + (isLast ? OFFICE_LAT + ',' + OFFICE_LNG : routeLocs[routeLocs.length - 1].lat + ',' + routeLocs[routeLocs.length - 1].lng);
      
      var waypoints = [];
      for (var i = (isFirst ? 0 : 1); i < (isLast ? routeLocs.length : routeLocs.length - 1); i++) {
        waypoints.push(routeLocs[i].lat + ',' + routeLocs[i].lng);
      }
      if (waypoints.length > 0) url += '&waypoints=' + waypoints.join('|');
      url += '&travelmode=driving';
      window.open(url, '_blank');
    }

    // Parse DMS format like "N35¬∞ 11' 15.19",W106¬∞ 30' 8.25"" to decimal
    function parseDMS(dmsStr) {
      if (!dmsStr) return null;
      // Match pattern: N/S followed by degrees, minutes, seconds, then W/E followed by degrees, minutes, seconds
      var pattern = /([NS])(\d+)[¬∞]\s*(\d+)['']\s*([\d.]+)[""']*\s*,\s*([WE])(\d+)[¬∞]\s*(\d+)['']\s*([\d.]+)/i;
      var match = String(dmsStr).match(pattern);
      if (!match) return null;
      
      var latDir = match[1].toUpperCase();
      var latDeg = parseFloat(match[2]);
      var latMin = parseFloat(match[3]);
      var latSec = parseFloat(match[4]);
      
      var lngDir = match[5].toUpperCase();
      var lngDeg = parseFloat(match[6]);
      var lngMin = parseFloat(match[7]);
      var lngSec = parseFloat(match[8]);
      
      var lat = latDeg + (latMin / 60) + (latSec / 3600);
      var lng = lngDeg + (lngMin / 60) + (lngSec / 3600);
      
      if (latDir === 'S') lat = -lat;
      if (lngDir === 'W') lng = -lng;
      
      return { lat: lat, lng: lng };
    }

    window.onload = function() {
      document.getElementById('file-input').onchange = function(e) {
        var file = e.target.files[0];
        if (!file) return;
        var reader = new FileReader();
        reader.onload = function(evt) {
          try {
            var wb = XLSX.read(evt.target.result, { type: 'binary' });
            var ws = wb.Sheets[wb.SheetNames[0]];
            var jsonData = XLSX.utils.sheet_to_json(ws);
            data = {};
            for (var i = 0; i < jsonData.length; i++) {
              var row = jsonData[i];
              // Try PARID from lat/long column first, then X Y column
              var parid = cleanUPC(row['PARID LAT LONG'] || row['PARID X Y'] || row['PARID'] || '');
              if (!parid) continue;
              
              // Try lat/long DMS format first
              var latLongUrl = row['DRIVING DIRECTIONS LAT LONG'] || '';
              var dmsMatch = String(latLongUrl).match(/origin=([NS][^,]+,[WE][^&\s]+)/i);
              if (dmsMatch) {
                var coords = parseDMS(dmsMatch[1]);
                if (coords) {
                  data[parid] = { lat: coords.lat, lng: coords.lng, url: latLongUrl };
                  continue;
                }
              }
              
              // Fall back to X Y decimal format
              var xyUrl = row['DRIVING DIRECTIONS'] || '';
              var xyMatch = String(xyUrl).match(/origin=([0-9.-]+),([0-9.-]+)/);
              if (xyMatch) {
                data[parid] = { lat: parseFloat(xyMatch[1]), lng: parseFloat(xyMatch[2]), url: xyUrl };
              }
            }
            document.getElementById('record-count').textContent = Object.keys(data).length.toLocaleString();
            hideEl('upload-section');
            showEl('success-banner');
            document.getElementById('upc-input').disabled = false;
            document.getElementById('search-btn').disabled = false;
            hideEl('error-msg');
          } catch (err) { alert('Error reading file: ' + err.message); }
        };
        reader.readAsBinaryString(file);
      };
    };

    function resetFile() {
      data = {};
      showEl('upload-section');
      hideEl('success-banner');
      document.getElementById('upc-input').disabled = true;
      document.getElementById('search-btn').disabled = true;
      document.getElementById('file-input').value = '';
      clearAll();
    }

    async function handleSearch() {
      var input = document.getElementById('upc-input').value;
      // Split on any whitespace (including non-breaking spaces) and clean each UPC
      var upcs = input.split(/[\s\u00A0,\n]+/).map(cleanUPC).filter(function(u) { return u.length > 0; });
      
      if (upcs.length === 0) { showError('Enter at least one UPC'); return; }

      var found = [], notFound = [];
      for (var i = 0; i < upcs.length; i++) {
        var upc = upcs[i]; // Already cleaned
        if (data[upc]) found.push({ upc: upc, lat: data[upc].lat, lng: data[upc].lng, url: data[upc].url, type: 'property' });
        else notFound.push(upc);
      }

      if (notFound.length > 0) showError('Not found: ' + notFound.join(', '));
      else hideEl('error-msg');

      if (found.length > 0) {
        found.sort(function(a, b) {
          var pa = parseUPC(a.upc), pb = parseUPC(b.upc);
          if (pa.letter !== pb.letter) return pa.letter.localeCompare(pb.letter);
          if (pa.mapNum !== pb.mapNum) return pa.mapNum - pb.mapNum;
          if (pa.quad !== pb.quad) return pa.quad - pb.quad;
          if (pa.block !== pb.block) return pa.block - pb.block;
          return pa.parcel - pb.parcel;
        });
        locations = found;
        fullRoute = [{ label: 'Office (Start)', lat: OFFICE_LAT, lng: OFFICE_LNG, type: 'start' }];
        for (var i = 0; i < found.length; i++) fullRoute.push(found[i]);
        fullRoute.push({ label: 'Office (End)', lat: OFFICE_LAT, lng: OFFICE_LNG, type: 'end' });
        
        updateRouteList();
        updateRouteButtons();
        showEl('route-section');
        setTimeout(async function() { 
          initMap(); 
          await updateMap(); 
        }, 100);
      }
    }

    function clearAll() {
      locations = []; fullRoute = [];
      document.getElementById('upc-input').value = '';
      hideEl('route-section'); hideEl('error-msg'); hideEl('route-stats'); hideEl('drag-hint');
      document.getElementById('route-note').classList.remove('show');
      if (map) { mapLayers.forEach(function(l) { map.removeLayer(l); }); mapLayers = []; }
    }

    function showError(msg) { document.getElementById('error-msg').textContent = msg; showEl('error-msg'); }
  </script>
</body>
</html>
